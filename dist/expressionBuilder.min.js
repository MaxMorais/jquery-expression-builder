/*! jQuery Expression Builder - v0.1.0 - 2014-05-05
* https://github.com/jonmbake/jquery-expression-builder
* Copyright (c) 2014 Jon Bake; Licensed MIT */
(function(e,t){function i(){this.onSelect=function(){},this.getDisplayText=function(){return""+this.displayName+(this.displayNameParens?" ("+this.displayNameParens+")":"")},this.getDescription=function(){return this.description},this.getId=function(){return this.displayName},this.getSelectObject=function(){return{text:this.getDisplayText(),id:this.getId()}},this.filter=function(e){var n=this.s$("div.exprInner input.subExprActive").data("returnType");if((!e.term||e.matcher.call(null,e.term,this.getDisplayText()))&&(!this.returnType||t.contains(n instanceof Array?n:[n],this.returnType)))return this.getSelectObject()}}function s(e,n){this.s$=n,t.extend(this,e)}function o(e,t){this.s$=t,this.displayName=e.displayName,this.returnType=e.returnType,this.subExprJSON=e}function u(e){this.displayName="Close List",this.description="Close the currently selected multi-sized list",this.s$=e}function a(e){this.displayName="Grouping",this.description="Group sub-expressions together",this.s$=e}function f(e){var n={},r=new u(e);n[r.displayName]=r;var i=new a(e);n[i.displayName]=i;var o="Number Literal",f=new s({returnType:"NUMBER",description:"A number literal"},e);f.filter=function(n){var r=e("div.exprInner input.subExprActive").data("returnType");return t.contains(r instanceof Array?r:[r],"NUMBER")&&(!n.term||n.term.match(/^(\+|-)?((\d+)|(\d+\.(\d+)?)|(\.(\d+)))$/g))?(n.term?n.term.charAt(n.term.length-1)==="."?this.displayName=n.term+"0":this.displayName=n.term:this.displayName="0",{text:o,id:o}):null},n[o]=f;var l="String Literal",c=new s({returnType:"TEXT",description:"A string literal"},e);return c.filter=function(n){var r=e("div.exprInner input.subExprActive").data("returnType");return t.contains(r instanceof Array?r:[r],"TEXT")&&(!n.term||n.term.charAt(0)==='"')?(n.term?n.term.charAt(n.term.length-1)!=='"'?this.displayName=n.term+'"':this.displayName=n.term:this.displayName='""',{text:l,id:l}):null},n[l]=c,n}function l(e,n,r){this.idMap=f(r),this.selectElements=t.values(this.idMap),this.s$=r,t.each(e,function(e){if(e.values instanceof Array)this.selectElements.push(new c(e,r,this.idMap));else{var t=new s(e,r);this.selectElements.push(t),this.idMap[t.getId()]=t}},this),this.templateGrouping=new c({groupName:"Templates",values:n},r,this.idMap,!0),this.selectElements.push(this.templateGrouping)}function c(e,n,r,i){this.displayName=i?"Template":e.groupName,this.s$=n,this.idMap=r,this.isTemplateGrouping=i,this.subExpressions=[],t.each(e.values,function(e){this.addSubExpressionToGrouping(e)},this)}function h(){this.getActiveElement=function(){return this.s$("div.exprInner .subExprActive")},this.makeActive=function(e){return this.s$("div.exprInner *").removeClass("subExprActive"),e.addClass("subExprActive"),e},this.afterActive=function(e){return this.getActiveElement().after(e),this.getActiveElement().removeClass("subExprActive"),this.makeActive(e),e},this.centerExpr=function(e){var t=this.s$("div.exprInner");t.width(e.width()+5)},this.focusNextInput=function(){var e=this.s$("div.exprInner > input:visible:eq(0)");e.length?e.focus():(this.s$().trigger("eb-expression-complete",E.getExpressionValue.call(this.s$())),this.s$("input.subExpr").select2("enable",!1))},this.addExpressionElement=function(t,n){var r=e("<span></span>").addClass("input-group-addon input-small").text(t);return n&&r.css({"font-weight":"bold"}),this.afterActive(r),this.expressionElements.push(r),this.s$(".exprInner span.input-small").removeAttr("style"),this.s$(".exprInner .input-small:visible:first").css({"border-top-left-radius":"3px","border-bottom-left-radius":"3px","padding-left":"10px","border-left":"1px solid #cccccc"}),r},this.addExpandableTypeInput=function(n){if(n.returnType==="PARENT")return;var r=e("<input></input>").attr({type:"text",placeholder:"?"}).data(n).addClass("form-control input-small").css({width:"30px"});return this.afterActive(r),r.focus(t.bind(function(t){var n=e(t.target);this.makeActive(n),this.s$("input.subExpr").select2("open")},this)),r.on("subExpressionSelect",t.bind(function(t,r){var i=e(t.target);i.data("subExpr",r),n.isMultiSized&&(this.addExpressionElement(","),this.addExpandableTypeInput(n),this.makeActive(i)),r.render()},this)),this.centerExpr(r),this.expandableInputs.push(r),r},this.getExpressionValue=function(){var e=this.expandableInputs[0].data("subExpr");return e?e.getExpressionValue():"{"+this.expandableInputs[0].data("returnType")+"}"},this.toJSON=function(){var e=this.expandableInputs[0];return e.data("subExpr")?e.data("subExpr").toJSON():JSON.stringify(e.data("returnType"))},this.remove=function(){t.each(this.expandableInputs,function(e){e.remove()}),t.each(this.expressionElements,function(e){e.remove()})}}function p(e,t){this.s$=e,this.expressionElements=[],this.expandableInputs=[],this.addExpandableTypeInput({returnType:t})}function d(e,t){this.s$=e,this.expressionElements=[],this.expandableInputs=[],this.expandableInputs=[this.addExpandableTypeInput({returnType:t})]}function v(n,r){this.s$=n,this.expressionElements=[],this.expandableInputs=[],this.isMultiSized=!1,this.addExpressionElement("(");if(typeof r=="string"){var i=this.parseType(r);e.each(i,t.bind(function(e,t){this.addExpandableTypeInput({returnType:t}),e!==i.length-1&&this.addExpressionElement(",")},this))}else e.each(r,t.bind(function(e,t){if(typeof t=="string")this.addExpandableTypeInput({returnType:t,component:this});else{var n=this.addExpandableTypeInput({returnType:t.returnType,component:this});n.trigger("subExpressionSelect",new b(this.s$,t))}e!==r.length-1&&this.addExpressionElement(",")},this));this.addExpressionElement(")")}function y(e,n){this.s$=e,this.expressionElements=[],this.expandableInputs=[],this.isMultiSized=!0,this.addExpressionElement("(");if(n)if(typeof n=="string")this.addExpandableTypeInput({returnType:n,isMultiSized:!0,component:this});else{var r=this.addExpandableTypeInput({returnType:"NUMBER",isMultiSized:!0,component:this});t.each(n,function(e){typeof e!="string"&&this.getActiveElement().trigger("subExpressionSelect",new b(this.s$,e))},this)}this.addExpressionElement(")")}function b(e,n){this.s$=e,this.expressionElements=[],this.expandableInputs=[],t.extend(this,n),t.isUndefined(n.expressionValue)&&(this.expressionValue=this.displayText)}var n='<div class="exprBldrMain panel panel-primary">    <div class="panel-heading"><h3 class="panel-title">Expression Builder</h3></div>      <div class="panel-body">      <div class="bldrBottom" style="margin-bottom: 5px">      <div style="float: left">        <label>Expression:</label>      </div>      <div class="btn-toolbar" style="float: right">            <div class="btn-group btn-group-xs">              <button type="button" class="btn btn-default back-btn">Back</button>              <button type="button" class="btn btn-default clear-btn">Clear</button>              <button type="button" class="btn btn-default save-as-btn">Save As Template</button>            </div>          </div>          </div>      <div class="exprOuter" >        <div class="exprInner input-group input-group-sm ">          <input type="text" class="subExprActive"></input>        </div>      </div>      <div class="bldrBottom">        <div style="float: left">          <label>Sub-Expression:</label><br/>          <input type="hidden" style="width:200px" class="subExpr"/>        </div>        <div class="panel panel-info" style="float: right; width: 250px">          <div class="panel-heading" >            <h6 class="panel-title" style="font-size: 14px">Help Text</h6>          </div>          <div class="panel-body">            <strong>Description</strong><br/><span class="helpDescription"></span>            <strong>Signature</strong><br/><span class="seSignature"></span>          </div>        </div>      </div>      </div>    </div>',r={returnType:"NUMBER",quickAdd:!0,quickRemove:!0};s.prototype=new i,s.prototype.onSelect=function(){var e=new b(this.s$,{leftComponent:this.leftType,displayText:this.displayName,expressionValue:this.expressionValue?this.expressionValue:this.displayName,rightComponent:this.rightType,returnType:this.returnType});this.s$("div.exprInner input.subExprActive").trigger("subExpressionSelect",e),e.focusNextInput()},s.prototype.getSignature=function(){return(this.leftType?"{"+this.leftType+"} ":"")+this.displayName+(this.rightType?" {"+this.rightType+"} ":"")},o.prototype=new i,o.prototype.onSelect=function(){var e=new b(this.s$,this.subExprJSON);e.render(),e.focusNextInput()},o.prototype.getSignature=function(){return""},o.prototype.filter=function(e){var n=this.s$("div.exprInner input.subExprActive").data("returnType");return(!e.term||e.matcher.call(null,e.term,this.getDisplayText()))&&(!this.returnType||t.contains(n instanceof Array?n:[n],this.returnType))?this.getSelectObject():null},u.prototype=new i,u.prototype.filter=function(e){var t=this.s$("div.exprInner input.subExprActive").data("isMultiSized");return!e.term&&t?this.getSelectObject():null},u.prototype.onSelect=function(){var e=this.s$("div.exprInner input.subExprActive");e.prev('span:contains(",")').remove();var t=e.data("component");e.data("component").expandableInputs.pop(),e.remove(),t.focusNextInput()},u.prototype.getSignature=function(){return""},a.prototype=new i,a.prototype.filter=function(e){return e.term?null:this.getSelectObject()},a.prototype.onSelect=function(t){var n=this.s$("div.exprInner input.subExprActive");n.data("isGrouped",!0),n.before(e("<span></span>").addClass("input-group-addon input-small").text("(")),n.after(e("<span></span>").addClass("input-group-addon input-small").text(")")),n.focus()},a.prototype.getSignature=function(){return"( )"},l.prototype={filter:function(e){var n=[];return t.each(this.selectElements,function(t){t.filter(e)&&n.push(t.filter(e))}),n},getById:function(e){return this.idMap[e]},addTemplate:function(e){this.templateGrouping.addSubExpressionToGrouping(e)}},c.prototype=new i,c.prototype.addSubExpressionToGrouping=function(e){var t=this.isTemplateGrouping?new o(e,this.s$):new s(e,this.s$);return this.subExpressions.push(t),this.idMap[t.getId()]=t,t},c.prototype.filter=function(e){var n=[];return t.each(this.subExpressions,function(t){t.filter(e)&&n.push(t.filter(e))}),n.length!==0?{text:this.getDisplayText(),children:n}:null},p.prototype=new h,d.prototype=new h,v.prototype=new h,v.prototype.parseType=function(e){if(e.charAt(0)==="("){var n=e.substring(1,e.length-1);return/\S/.test(n)?t.map(n.split(","),function(e){return e.trim()}):[]}return e};var m=v.prototype.getExpressionValue=function(){return"("+t.map(this.expandableInputs,function(e){return e.data("subExpr")?e.data("subExpr").getExpressionValue():"{"+e.data("returnType")+"}"}).join(",")+")"},g=v.prototype.toJSON=function(){return'{ "type": "LIST", "isMultiSized": '+JSON.stringify(this.isMultiSized)+', "values": ['+t.map(this.expandableInputs,function(e){return e.data("subExpr")?e.data("subExpr").toJSON():JSON.stringify(e.data("returnType"))}).join(",")+"]}"};y.prototype=new h,y.prototype.getExpressionValue=m,y.prototype.toJSON=g,b.prototype=new h,b.prototype.resolveComponent=function(e){if(!e)return;if(typeof e=="string"&&e.charAt(0)==="(")return e.substring(e.length-4,e.length-1)==="..."?new y(this.s$,e.substring(1,e.length-4)):new v(this.s$,e);if(typeof e=="string")return new d(this.s$,e);if(e instanceof Array)return new p(this.s$,e);if(e.type&&e.type==="LIST"){var t;return e.isMultiSized?new y(this.s$,e.values):new v(this.s$,e.values)}return this.addExpandableTypeInput({returnType:e.returnType}),new b(this.s$,e)},b.prototype.render=function(){this.parentElement=this.getActiveElement(),this.isGrouped=this.parentElement.data("isGrouped"),this.parentElement.hide().trigger("hide",this.returnType),this.leftComponent=this.resolveComponent(this.leftComponent),this.leftComponent&&this.leftComponent.render instanceof Function&&this.leftComponent.render(),this.displayText&&(this.expressionElement=this.addExpressionElement(this.displayText)),this.rightComponent=this.resolveComponent(this.rightComponent),this.rightComponent&&this.rightComponent.render instanceof Function&&this.rightComponent.render();if(this.rightComponent instanceof p&&this.leftComponent instanceof p){var e=this.leftComponent.expandableInputs[0],t=this.rightComponent.expandableInputs[0];e.on("hide",function(e,n){t.data("returnType",n)}),t.on("hide",function(t,n){e.data("returnType",n)})}this.s$().trigger("eb-subexpression-add",this)},b.prototype.getExpressionValue=function(){var e=[];return this.isGrouped&&e.push("("),this.leftComponent&&this.leftComponent.getExpressionValue()!==undefined&&e.push(this.leftComponent.getExpressionValue()),this.expressionValue!==undefined&&e.push(this.expressionValue),this.rightComponent&&this.rightComponent.getExpressionValue()!==undefined&&e.push(this.rightComponent.getExpressionValue()),this.isGrouped&&e.push(")"),e.join(" ")},b.prototype.toJSON=function(){var e=[];return e.push('"isGrouped": '+JSON.stringify(!!this.isGrouped)),e.push('"returnType": '+JSON.stringify(this.returnType)),this.leftComponent&&this.leftComponent.toJSON()!==undefined&&e.push('"leftComponent": '+this.leftComponent.toJSON()),t.each(["expressionValue","displayText","returnType"],function(t){this[t]!==undefined&&e.push(JSON.stringify(t)+": "+JSON.stringify(this[t]))},this),this.rightComponent&&this.rightComponent.getExpressionValue()!==undefined&&e.push('"rightComponent": '+this.rightComponent.toJSON()),"{"+e.join(", ")+"}"},b.prototype.remove=function(){this.leftComponent&&this.leftComponent.remove(),t.each(this.expressionElements,function(e){e.remove()}),this.rightComponent&&this.rightComponent.remove(),this.parentElement.show().focus()};var w={init:function(i,s,o){this.$elem=i,this.options=e.extend({},r,o),i.append(n);var u=function(e){return e?i.find(e):i};this.s$=u,this.expressionReturnType=this.options.returnType,this.addStartSubExpresion(),this.options.expressionURL&&e.get(this.options.getExpressionURL,function(e){t.extend(s,e)}),this.selectElementCollection=new l(s,this.getTemplates(),u);var a=e("input.subExpr");this.subExprSelect=a;var f=a.select2({placeholder:"Select a Sub-Expression",initSelection:t.bind(function(e,t){e.val()&&(this.selectElementCollection.getById(e.val()).onSelect(),a.select2("val","").select2("close").select2("open")),t({id:"",text:""})},this),query:t.bind(function(e){var n={};n.results=this.selectElementCollection.filter(e);var r=t.chain(n.results).map(function(e){return e.id||t.pluck(e.children,"id")}).flatten().value();this.options.quickAdd&&r.length===1&&(a.select2("val","").select2("close"),this.selectElementCollection.getById(r[0]).onSelect()),e.callback(n)},this)});a.on("change",t.bind(function(e){a.select2("val","").select2("close");var t=this.selectElementCollection.getById(e.added.id);t&&t.onSelect()},this)),a.on("select2-highlight",t.bind(function(e){var t=this.selectElementCollection.getById(e.choice.id);t?(u("span.helpDescription").text(t.getDescription()),t.getSignature instanceof Function&&u("span.seSignature").text(t.getSignature())):(u("span.helpDescription").text("N/A"),u("span.seSignature").text("N/A"))},this)),a.on("select2-close",function(e){u("span.helpDescription").text("N/A"),u("span.seSignature").text("N/A")});var c=this;e(".select2-input").keydown(function(t){c.options.quickRemove&&t.which===8&&e(this).val().length===0&&c.back()}),u(".back-btn").on("click",t.bind(function(){this.back()},this)),u(".clear-btn").on("click",t.bind(function(){this.clear()},this)),u(".save-as-btn").on("click",t.bind(function(){this.saveAsTemplate()},this)),u("div.exprInner input:visible").eq(0).focus()},getExpression:function(){return this.startSubExpression.getExpressionValue()},getJSON:function(){return e.parseJSON(this.startSubExpression.toJSON())},addStartSubExpresion:function(){this.startSubExpression=new d(this.s$,this.expressionReturnType),this.s$("div.exprInner input:first").remove(),this.startSubExpression.focusNextInput()},clear:function(){this.subExprSelect.select2("data",null).select2("enable",!0).select2("close"),this.s$(".exprInner").empty().append('<input type="text" class="subExprActive"></input>'),this.addStartSubExpresion(),this.s$().trigger("eb-clear")},back:function(){var e=this.s$(".exprInner input:not(:visible)").last();e&&e.data("subExpr")&&e.data("subExpr").remove(),this.s$().trigger("eb-back")},getTemplates:function(){if(this.options.templateURL){var t;return e.get(this.options.templateURL,function(e){t=e}),t}return window.localStorage.getItem("ebTemplates")?e.parseJSON(window.localStorage.getItem("ebTemplates")):{}},saveAsTemplate:function(n){n||(n=window.prompt("Please enter a name for the template"));if(n==="")return;var r=t.extend(this.getJSON(),{displayName:n});if(this.options.templateURL)e.ajax({type:"POST",url:this.options.templateURL,data:r,success:t.bind(function(){this.selectElementCollection.addTemplate(r)},this),dataType:"json"});else{window.localStorage.getItem("ebTemplates")||window.localStorage.setItem("ebTemplates","[]");var i=e.parseJSON(window.localStorage.getItem("ebTemplates"));i.push(r),window.localStorage.setItem("ebTemplates",JSON.stringify(i)),this.selectElementCollection.addTemplate(r)}}},E={init:function(e,t){var n=Object.create(w);return n.init(this,e,t),this.data("expressionBuilder",n),this},getExpressionValue:function(){return this.data("expressionBuilder").getExpression()},getExpressionJSON:function(){return this.data("expressionBuilder").getJSON()},clearExpression:function(){this.data("expressionBuilder").clear()},back:function(){this.data("expressionBuilder").back()},saveAsTemplate:function(e){this.data("expressionBuilder").saveAsTemplate(e)},getTemplates:function(){return this.data("expressionBuilder").getTemplates()},setReturnType:function(e){this.data("expressionBuilder").expressionReturnType=e,this.data("expressionBuilder").clear()}};e.fn.expressionBuilder=function(n){var r=arguments,i=this.map(function(){var i=e(this);if(typeof n=="object")return E.init.apply(e(this),r);if(typeof n=="string"&&E[n])return E[n].apply(e(this),t.rest(r));throw new Error("Calling method that is not part of the API")});return i.length===1?i[0]:i}})(jQuery,_);